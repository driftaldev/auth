// Prisma schema for driftal Backend
// Uses Supabase PostgreSQL database

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User Profiles
// ============================================================================

/// User profiles extending Supabase auth.users
/// Stores cached user data for easier querying
model UserProfile {
  id             String   @id @db.Uuid // References auth.users(id)
  email          String   @db.VarChar(255)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  reviewLogs     ReviewLog[]

  @@index([email])
  @@map("user_profiles")
}

// ============================================================================
// Review Logs
// ============================================================================

/// Code review logs tracking complete review sessions
/// Tracks review metadata, tokens used, and code metrics
model ReviewLog {
  id                   String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String        @map("user_id") @db.Uuid
  email                String        @db.VarChar(255)
  model                String        @db.VarChar(100)
  totalTokens          Int?          @map("total_tokens")
  linesOfCodeReviewed  Int?          @map("lines_of_code_reviewed")
  reviewDurationMs     Int?          @map("review_duration_ms")
  repositoryName       String?       @map("repository_name") @db.VarChar(255)
  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user                 UserProfile   @relation(fields: [userId], references: [id], onDelete: Cascade)
  issues               ReviewIssue[]

  @@index([userId])
  @@index([createdAt])
  @@index([model])
  @@index([email])
  @@index([repositoryName])
  @@index([email, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("usage_logs")
}

// ============================================================================
// Review Issues
// ============================================================================

/// Individual issues found during code reviews
/// Linked to review logs with severity levels
model ReviewIssue {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reviewId     String      @map("review_id") @db.Uuid
  title        String      @db.Text
  severity     Severity
  filePath     String      @map("file_path") @db.Text
  lineNumber   Int?        @map("line_number")
  description  String?     @db.Text
  suggestion   String?     @db.Text
  createdAt    DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  review       ReviewLog   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([severity])
  @@index([filePath])
  @@index([createdAt])
  @@index([reviewId, severity])
  @@map("review_issues")
}

// ============================================================================
// Enums
// ============================================================================

enum Severity {
  critical
  high
  medium
  low
}
